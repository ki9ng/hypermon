<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperMon</title>
    <style>
        /* Reset default browser styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Main body styling with gradient background */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Main container with max width for readability */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header section styling */
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 28px;
        }

        /* Configuration panel styling */
        .settings-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .settings-panel h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 20px;
        }

        /* Form input group styling */
        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        /* Text input fields styling */
        input[type="text"], input[type="url"], input[type="number"] {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="url"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #2a5298;
        }

        /* Button group container */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Base button styling */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* Primary button variant */
        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Secondary button variant */
        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Success button variant */
        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* Tab navigation container */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Individual tab button */
        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #1e3c72;
            transition: all 0.3s;
        }

        /* Active tab state */
        .tab.active {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
        }

        /* Tab content container */
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 0 12px 12px 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Active tab content state */
        .tab-content.active {
            display: block;
        }

        /* Grid layout for node cards */
        .node-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        /* Individual node card styling */
        .node-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .node-card:hover {
            border-color: #2a5298;
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.2);
            transform: translateY(-2px);
        }

        /* Node number display */
        .node-number {
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        /* Node callsign display */
        .node-callsign {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        /* Node information text */
        .node-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
        }

        /* Status indicator dot */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        /* Keyed status color (green) */
        .status-keyed {
            background: #28a745;
        }

        /* Idle status color (gray) */
        .status-idle {
            background: #6c757d;
        }

        /* Search results container */
        .search-results {
            margin-top: 20px;
        }

        /* Loading state message */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        /* Error message styling */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        /* Success message styling */
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        /* Information box styling */
        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        /* Table styling for search results */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #1e3c72;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Smaller button for table cells */
        .connect-btn {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Responsive design for mobile devices */
        @media (max-width: 768px) {
            .node-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header>
            <h1>HyperMon</h1>
            <p>Streamlined node search and connection for AllMon3</p>
        </header>

        <!-- Configuration Panel -->
        <div class="settings-panel">
            <h2>Configuration</h2>
            <div class="input-group">
                <label for="allmon-url">AllMon3 URL:</label>
                <input type="url" id="allmon-url" placeholder="http://your-allmon3-server/allmon3" value="">
            </div>
            <div class="input-group">
                <label for="your-node">Your Node Number:</label>
                <input type="number" id="your-node" placeholder="e.g., 12345">
            </div>
            <div class="input-group">
                <label for="proxy-url">Proxy Server URL (optional):</label>
                <input type="url" id="proxy-url" placeholder="http://localhost:5000" value="http://localhost:5000">
                <small style="color: #666; display: block; margin-top: 5px;">Leave as localhost:5000 if running the Python proxy locally</small>
            </div>
            <button class="btn-success" onclick="saveSettings()">Save Settings</button>
            <div id="settings-status"></div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('keyed')">Currently Keyed</button>
            <button class="tab" onclick="switchTab('search')">Search by Callsign</button>
            <button class="tab" onclick="switchTab('manual')">Manual Entry</button>
        </div>

        <!-- Currently Keyed Tab -->
        <div id="keyed-tab" class="tab-content active">
            <h2>Currently Active (Keyed) Nodes</h2>
            <div class="info-box">
                Click "Refresh" to load currently keyed nodes from AllStarLink stats. Click any node to connect via AllMon3.
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="loadKeyedNodes()">Refresh Keyed Nodes</button>
                <button class="btn-secondary" onclick="toggleAutoRefresh()"><span id="auto-refresh-text">Enable Auto-Refresh</span></button>
            </div>
            <div id="keyed-status"></div>
            <div id="keyed-nodes" class="node-list"></div>
        </div>

        <!-- Search by Callsign Tab -->
        <div id="search-tab" class="tab-content">
            <h2>Search by Callsign or Node</h2>
            <div class="info-box">
                Enter a callsign or node number to search the AllStarLink database.
            </div>
            <div class="input-group">
                <label for="search-input">Callsign or Node Number:</label>
                <input type="text" id="search-input" placeholder="Enter callsign (e.g., W1ABC) or node number">
            </div>
            <button class="btn-primary" onclick="searchNodes()">Search</button>
            <div id="search-status"></div>
            <div id="search-results" class="search-results"></div>
        </div>

        <!-- Manual Entry Tab -->
        <div id="manual-tab" class="tab-content">
            <h2>Manual Node Connection</h2>
            <div class="info-box">
                Directly enter a node number to connect.
            </div>
            <div class="input-group">
                <label for="manual-node">Node Number:</label>
                <input type="number" id="manual-node" placeholder="Enter node number">
            </div>
            <button class="btn-primary" onclick="connectManualNode()">Connect to Node</button>
            <div id="manual-status"></div>
        </div>
    </div>

    <script>
        /**
         * HyperMon - JavaScript
         * Handles settings, API calls, and UI interactions
         */

        /**
         * Settings object - stores user configuration in localStorage
         */
        let settings = {
            allmonUrl: localStorage.getItem('allmonUrl') || '',
            yourNode: localStorage.getItem('yourNode') || '',
            proxyUrl: localStorage.getItem('proxyUrl') || 'http://localhost:5000'
        };

        /**
         * Auto-refresh interval handle
         */
        let autoRefreshInterval = null;

        /**
         * Load saved settings on page load
         */
        window.onload = function() {
            document.getElementById('allmon-url').value = settings.allmonUrl;
            document.getElementById('your-node').value = settings.yourNode;
            if (document.getElementById('proxy-url')) {
                document.getElementById('proxy-url').value = settings.proxyUrl;
            }
        };

        /**
         * Save user settings to localStorage
         */
        function saveSettings() {
            settings.allmonUrl = document.getElementById('allmon-url').value;
            settings.yourNode = document.getElementById('your-node').value;
            settings.proxyUrl = document.getElementById('proxy-url').value || 'http://localhost:5000';
            
            localStorage.setItem('allmonUrl', settings.allmonUrl);
            localStorage.setItem('yourNode', settings.yourNode);
            localStorage.setItem('proxyUrl', settings.proxyUrl);
            
            document.getElementById('settings-status').innerHTML = '<div class="success">Settings saved!</div>';
            setTimeout(() => {
                document.getElementById('settings-status').innerHTML = '';
            }, 3000);
        }

        /**
         * Switch between tabs
         * @param {string} tabName - Name of tab to switch to (keyed, search, or manual)
         */
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            // Remove active class from all tabs and contents
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            document.querySelector(`.tab:nth-child(${tabName === 'keyed' ? 1 : tabName === 'search' ? 2 : 3})`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        /**
         * Connect to a node via AllMon3
         * Opens AllMon3 link.php in a new tab
         * @param {string} nodeNumber - Node number to connect to
         */
        function connectToNode(nodeNumber) {
            if (!settings.allmonUrl || !settings.yourNode) {
                alert('Please configure your AllMon3 URL and your node number in the Configuration section first.');
                return;
            }

            // AllMon3 connection URL format
            const connectUrl = `${settings.allmonUrl}/link.php?node=${settings.yourNode}&links=${nodeNumber}`;
            
            // Open in new tab
            window.open(connectUrl, '_blank');
            
            // Show confirmation message
            const statusDiv = document.getElementById('keyed-status') || document.getElementById('search-status') || document.getElementById('manual-status');
            statusDiv.innerHTML = `<div class="success">Connection request sent to node ${nodeNumber}. Check your AllMon3 interface.</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        /**
         * Load currently keyed nodes from proxy API
         * Makes async fetch call to /api/keyed-nodes endpoint
         */
        async function loadKeyedNodes() {
            const statusDiv = document.getElementById('keyed-status');
            const nodesDiv = document.getElementById('keyed-nodes');
            
            statusDiv.innerHTML = '<div class="loading">Loading keyed nodes...</div>';
            
            try {
                const response = await fetch(`${settings.proxyUrl}/api/keyed-nodes`);
                const data = await response.json();
                
                if (data.success && data.nodes.length > 0) {
                    displayNodes(data.nodes, nodesDiv);
                    statusDiv.innerHTML = `<div class="success">Loaded ${data.count} keyed node(s)</div>`;
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else if (data.success && data.nodes.length === 0) {
                    nodesDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No nodes currently keyed</p>';
                    statusDiv.innerHTML = '<div class="success">No keyed nodes at this time</div>';
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Failed to load nodes');
                }
            } catch (error) {
                console.error('Error loading keyed nodes:', error);
                statusDiv.innerHTML = `<div class="error">Error: ${error.message}<br><small>Make sure the proxy server is running (python3 hypermon-proxy.py)</small></div>`;
            }
        }

        /**
         * Search for nodes by callsign or node number
         * Makes async fetch call to /api/search-nodes endpoint
         */
        async function searchNodes() {
            const searchTerm = document.getElementById('search-input').value.trim().toUpperCase();
            const statusDiv = document.getElementById('search-status');
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchTerm) {
                statusDiv.innerHTML = '<div class="error">Please enter a callsign or node number.</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                const response = await fetch(`${settings.proxyUrl}/api/search-nodes?q=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    let html = '<table><thead><tr><th>Node</th><th>Callsign</th><th>Location</th><th>Description</th><th>Action</th></tr></thead><tbody>';
                    
                    data.results.forEach(node => {
                        html += `
                            <tr>
                                <td><strong>${node.node}</strong></td>
                                <td>${node.callsign}</td>
                                <td>${node.location}</td>
                                <td>${node.description || '-'}</td>
                                <td><button class="btn-primary connect-btn" onclick="connectToNode('${node.node}')">Connect</button></td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    resultsDiv.innerHTML = html;
                    statusDiv.innerHTML = `<div class="success">Found ${data.count} result(s)</div>`;
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else if (data.success && data.results.length === 0) {
                    resultsDiv.innerHTML = '';
                    statusDiv.innerHTML = '<div class="error">No results found.</div>';
                } else {
                    throw new Error(data.error || 'Search failed');
                }
            } catch (error) {
                console.error('Error searching nodes:', error);
                resultsDiv.innerHTML = '';
                statusDiv.innerHTML = `<div class="error">Error: ${error.message}<br><small>Make sure the proxy server is running</small></div>`;
            }
        }

        /**
         * Connect to manually entered node number
         */
        function connectManualNode() {
            const nodeNumber = document.getElementById('manual-node').value;
            const statusDiv = document.getElementById('manual-status');
            
            if (!nodeNumber) {
                statusDiv.innerHTML = '<div class="error">Please enter a node number.</div>';
                return;
            }
            
            connectToNode(nodeNumber);
        }

        /**
         * Display nodes in grid layout
         * @param {Array} nodes - Array of node objects
         * @param {HTMLElement} container - DOM element to render nodes into
         */
        function displayNodes(nodes, container) {
            let html = '';
            
            nodes.forEach(node => {
                html += `
                    <div class="node-card" onclick="connectToNode('${node.node}')">
                        <div class="node-number">
                            <span class="status-indicator status-${node.status}"></span>
                            ${node.node}
                        </div>
                        <div class="node-callsign">${node.callsign}</div>
                        <div class="node-info">Location: ${node.location}</div>
                        ${node.description ? `<div class="node-info">${node.description}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        /**
         * Toggle auto-refresh of keyed nodes
         * Refreshes every 30 seconds when enabled
         */
        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('auto-refresh-text').textContent = 'Enable Auto-Refresh';
            } else {
                autoRefreshInterval = setInterval(loadKeyedNodes, 30000); // Refresh every 30 seconds
                document.getElementById('auto-refresh-text').textContent = 'Disable Auto-Refresh';
                loadKeyedNodes(); // Load immediately
            }
        }

        /**
         * Keyboard shortcuts
         * Ctrl/Cmd + K: Jump to search tab
         */
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                switchTab('search');
                document.getElementById('search-input').focus();
            }
        });

        /**
         * Add Enter key support for search and manual entry
         */
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchNodes();
                }
            });
            
            document.getElementById('manual-node').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    connectManualNode();
                }
            });
        });
    </script>
</body>
</html>
